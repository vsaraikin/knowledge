# Cassandra

## Какую проблему решает?

- Отсутствие единой точки отказа (нет мастера, все равны)
- Легко добавить новый узел
- Оптимизирована для высокой скорости записи благодаря [SSTables](#SSTable)  и [Memtable](#Memtable)
- Глобальная доступность (синхронизация между ДЦ в разных странах)
- Гибкая схема и быстрый доступ по PK

## Gossip


## Replication

### Что такое фактор репликации и как он влияет на данные?

#### Доступность, надежность и производительность

Высокий фактор увеличивает доступность и надежность.

С прозводительностью иначе: запись ускоряется при нагрузке, а чтение замедляется.

#### Уровни консистентности

Фактор репликации тесно связан с уровнями консистентности, которые задают, сколько узлов должны подтвердить операцию для ее успешного завершения.

Например, уровень консистентности QUORUM требует подтверждения большинства узлов. В кластере с фактором репликации 3 это будет 2 узла (большинство из 3).

### Стратегии репликации

- **SimpleStrategy**: Используется для одного дата-центра. Реплики размещаются по кольцу
- **NetworkTopologyStrategy**: Используется для многодатацентровых кластеров. Позволяет задать фактор репликации отдельно для каждого дата-центра.

## Consistency

### Consistency levels

- **ANY**
	- Запись: Операция записи считается успешной, если хотя бы одна реплика (включая Hinted Handoff) принимает запись.
	- Чтение: Не применимо.
- **ONE**
	- Запись: Операция записи считается успешной, если одна реплика подтверждает запись.
	- Чтение: Операция чтения считается успешной, если одна реплика возвращает данные.
- **QUORUM**
	- Запись: Операция записи считается успешной, если большинство реплик (более половины) подтверждают запись.
	- Чтение: Операция чтения считается успешной, если большинство реплик возвращают данные.
- **LOCAL_QUORUM**
	- Запись: Операция записи считается успешной, если большинство реплик в локальном дата-центре подтверждают запись.
	- Чтение: Операция чтения считается успешной, если большинство реплик в локальном дата-центре возвращают данные.
- **EACH_QUORUM**
	- Запись: Операция записи считается успешной, если большинство реплик в каждом дата-центре подтверждают запись.
	- Чтение: Не применимо.
- **ALL**
	- Запись: Операция записи считается успешной, если все реплики подтверждают запись.
	- Чтение: Операция чтения считается успешной, если все реплики возвращают данные.


### CAP Theorem

Cassandra выбирает AP (Availability and Partition Tolerance) модель из теоремы CAP, обеспечивая высокую доступность и устойчивость к разделению, даже если это иногда означает ослабленную консистентность.

- **Partition Tolerance**: Cassandra разработана для работы в распределенной среде, где разделение сети (network partitions) является обычным явлением. Она продолжает работать, даже если некоторые узлы не могут общаться друг с другом.
- **Availability**: Cassandra гарантирует, что запросы всегда будут обработаны, если хотя бы один узел доступен, за счет ослабления требований к консистентности.

#### Настройка уровней консистентности и их влияние на CAP

Уровни консистентности в Cassandra позволяют гибко управлять балансом между консистентностью и доступностью:

- **Высокая доступность (низкая консистентность)**: Уровни консистентности, такие как ANY и ONE, обеспечивают максимальную доступность, так как операции считаются завершенными, если они подтверждены хотя бы одной репликой. Это подходит для приложений, где важна скорость и доступность, даже если это означает временные несогласованности данных.

- **Высокая консистентность (низкая доступность)**: Уровни консистентности, такие как QUORUM и ALL, обеспечивают высокую консистентность данных, так как требуют подтверждения большинства или всех реплик. Это подходит для приложений, где критически важна точность данных, даже если это увеличивает задержки и снижает доступность в случае сбоев.

## Процесс чтения и записи

![cassandra-read-write](cassandra-read-write.png)

### Memtable

**Memtable** — это временная структура данных в памяти, используемая для буферизации операций записи перед их сбросом на диск. Когда данные записываются в Cassandra, они сначала помещаются в Memtable и журнал транзакций (Commit Log) для обеспечения надежности. Memtable представляет собой сбалансированное дерево, которое хранит данные в отсортированном виде.

### SSTable

**SSTable (Sorted String Table)** — это неизменяемый файл на диске, который хранит данные, сброшенные из Memtable. SSTables хранят данные в отсортированном виде, что облегчает их эффективное чтение и слияние.

[Apache Cassandra. Запись данных. Часть 3 — SSTable - blog.bissquit.com](https://blog.bissquit.com/dbms/apache-cassandra-zapis-dannyh-chast-3-sstable/)

### Bloom filter

**Bloom Filter** — это вероятностная структура данных, используемая для быстрой проверки наличия элемента в множестве. В Cassandra Bloom фильтры используются для минимизации количества обращений к диску при чтении данных из SSTable.


### Процесс записи и чтения данных

#### Запись данных

1. **Запись в Memtable и Commit Log**:
    - Данные записываются в Memtable и Commit Log. Это гарантирует, что данные будут сохранены даже в случае сбоя.
2. **Сброс Memtable в SSTable**:
    - Когда Memtable достигает порогового значения, она сбрасывается на диск в виде SSTable.
3. **Компакция**:
    - Периодически выполняется процесс компакции, при котором несколько SSTable объединяются в одну, чтобы уменьшить количество SSTable и оптимизировать использование дискового пространства.

#### Чтение данных

1. **Поиск в Memtable**:
    - Запрос сначала проверяет Memtable на наличие данных. Если данные найдены, они возвращаются немедленно.
2. **Проверка Bloom фильтра**:
    - Если данные не найдены в Memtable, проверяется Bloom фильтр соответствующих SSTable, чтобы определить, следует ли обращаться к этим SSTable.
3. **Чтение из SSTable**:
    - Если Bloom фильтр показывает возможное наличие данных, SSTable читается для получения данных. Если данные распределены по нескольким SSTable, выполняется объединение данных.