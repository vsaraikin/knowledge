# Cassandra

## Какую проблему решает?

- Отсутствие единой точки отказа (нет мастера, все равны)
- Легко добавить новый узел
- Оптимизирована для высокой скорости записи благодаря [SSTables](#SSTable)  и [Memtable](#Memtable)
- Глобальная доступность (синхронизация между ДЦ в разных странах)
- Гибкая схема и быстрый доступ по PK

## Gossip

**Gossip** — это протокол коммуникации, используемый узлами Cassandra для обмена информацией о состоянии и топологии кластера. Протокол Gossip обеспечивает децентрализованное управление кластером, что позволяет узлам быть в курсе состояния друг друга без единой точки отказа.

## Replication

### Что такое фактор репликации и как он влияет на данные?

#### Доступность, надежность и производительность

Высокий фактор увеличивает доступность и надежность.

С прозводительностью иначе: запись ускоряется при нагрузке, а чтение замедляется.

#### Уровни консистентности

Фактор репликации тесно связан с уровнями консистентности, которые задают, сколько узлов должны подтвердить операцию для ее успешного завершения.

Например, уровень консистентности QUORUM требует подтверждения большинства узлов. В кластере с фактором репликации 3 это будет 2 узла (большинство из 3).

### Стратегии репликации

- **SimpleStrategy**: Используется для одного дата-центра. Реплики размещаются по кольцу
- **NetworkTopologyStrategy**: Используется для многодатацентровых кластеров. Позволяет задать фактор репликации отдельно для каждого дата-центра.

## Consistency

### Consistency levels

- **ANY**
	- Запись: Операция записи считается успешной, если хотя бы одна реплика (включая Hinted Handoff) принимает запись.
	- Чтение: Не применимо.
- **ONE**
	- Запись: Операция записи считается успешной, если одна реплика подтверждает запись.
	- Чтение: Операция чтения считается успешной, если одна реплика возвращает данные.
- **QUORUM**
	- Запись: Операция записи считается успешной, если большинство реплик (более половины) подтверждают запись.
	- Чтение: Операция чтения считается успешной, если большинство реплик возвращают данные.
- **LOCAL_QUORUM**
	- Запись: Операция записи считается успешной, если большинство реплик в локальном дата-центре подтверждают запись.
	- Чтение: Операция чтения считается успешной, если большинство реплик в локальном дата-центре возвращают данные.
- **EACH_QUORUM**
	- Запись: Операция записи считается успешной, если большинство реплик в каждом дата-центре подтверждают запись.
	- Чтение: Не применимо.
- **ALL**
	- Запись: Операция записи считается успешной, если все реплики подтверждают запись.
	- Чтение: Операция чтения считается успешной, если все реплики возвращают данные.


### CAP Theorem

Cassandra выбирает AP (Availability and Partition Tolerance) модель из теоремы CAP, обеспечивая высокую доступность и устойчивость к разделению, даже если это иногда означает ослабленную консистентность.

- **Partition Tolerance**: Cassandra разработана для работы в распределенной среде, где разделение сети (network partitions) является обычным явлением. Она продолжает работать, даже если некоторые узлы не могут общаться друг с другом.
- **Availability**: Cassandra гарантирует, что запросы всегда будут обработаны, если хотя бы один узел доступен, за счет ослабления требований к консистентности.

#### Настройка уровней консистентности и их влияние на CAP

Уровни консистентности в Cassandra позволяют гибко управлять балансом между консистентностью и доступностью:

- **Высокая доступность (низкая консистентность)**: Уровни консистентности, такие как ANY и ONE, обеспечивают максимальную доступность, так как операции считаются завершенными, если они подтверждены хотя бы одной репликой. Это подходит для приложений, где важна скорость и доступность, даже если это означает временные несогласованности данных.

- **Высокая консистентность (низкая доступность)**: Уровни консистентности, такие как QUORUM и ALL, обеспечивают высокую консистентность данных, так как требуют подтверждения большинства или всех реплик. Это подходит для приложений, где критически важна точность данных, даже если это увеличивает задержки и снижает доступность в случае сбоев.

## Процесс чтения и записи

![cassandra-read-write](cassandra-read-write.png)

### Memtable

**Memtable** — это временная структура данных в памяти, используемая для буферизации операций записи перед их сбросом на диск. Когда данные записываются в Cassandra, они сначала помещаются в Memtable и журнал транзакций (Commit Log) для обеспечения надежности. Memtable представляет собой сбалансированное дерево, которое хранит данные в отсортированном виде.

Свойства:

- Элементы, хранящиеся в Memtable, отсортированы по ключам записей;
- Данные внутри записей отсортированы по колонкам;
- Для поиска и вставки элементов используется алгоритм _Java ConcurrentSkipListMap_;
- Для каждого колоночного семейства существует отдельная MemTable (в английской терминологии Memtable описывается как _per-ColumnFamily structure_ **[1](https://blog.bissquit.com/dbms/apache-cassandra-zapis-dannyh-chast-2-memtable/#note-863-1 "MemtableSSTable")**).

*Reference:* [Apache Cassandra. Запись данных. Часть 2 - Memtable - blog.bissquit.com](https://blog.bissquit.com/dbms/apache-cassandra-zapis-dannyh-chast-2-memtable/)

### SSTable

**SSTable (Sorted String Table)** — это неизменяемый файл на диске, который хранит данные, сброшенные из Memtable. SSTables хранят данные в отсортированном виде, что облегчает их эффективное чтение и слияние.

Свойства:

- неизменность (immutable);
- существуют на каждое колоночное семейство;
- для каждой SSTable создается индекс раздела (partition index), сводка раздела (partition summary), bloom-фильтр;

*Reference:* [Apache Cassandra. Запись данных. Часть 3 — SSTable - blog.bissquit.com](https://blog.bissquit.com/dbms/apache-cassandra-zapis-dannyh-chast-3-sstable/)

### Bloom filter

**Bloom Filter** — это вероятностная структура данных, используемая для быстрой проверки наличия элемента в множестве. В Cassandra Bloom фильтры используются для минимизации количества обращений к диску при чтении данных из SSTable.

### Процесс записи и чтения данных

![cassandra-write](cassandra-write.png)

![cassandra-write-02](cassandra-write-02.png)

#### Запись

1. **Запись в Commit Log и Memtable**: Запись Commit Log для обеспечения долговечности. Данные также записываются в Memtable, которая находится в оперативной памяти и используется для буферизации операций записи.
2. **Сброс данных в SSTable**: Когда Memtable достигает порогового значения объема или времени, данные сбрасываются на диск в виде SSTable. SSTable неизменяемы и хранят данные в отсортированном виде.
3. **Компакция**: Периодически выполняется процесс *компакции*, при котором несколько SSTable объединяются в одну, чтобы уменьшить количество SSTable и оптимизировать использование дискового пространства.

#### Чтение

1. **Поиск в Memtable**: Запрос сначала проверяет *Memtable* на наличие данных. Если данные найдены, они возвращаются немедленно.
2. **Проверка Bloom фильтра**: Если данные не найдены в *Memtable*, проверяется *Bloom* *фильтр* соответствующих *SSTable*, чтобы определить, следует ли обращаться к этим *SSTable*.
3. **Чтение из SSTable**: Если *Bloom фильтр* показывает возможное наличие данных, *SSTable* читается для получения данных. Если данные распределены по нескольким *SSTable*, выполняется объединение данных.