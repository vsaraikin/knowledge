# Databases

- [General](#general)
    + [Разница SQL и NoSQL баз данных](#%D1%80%D0%B0%D0%B7%D0%BD%D0%B8%D1%86%D0%B0-sql-%D0%B8-nosql-%D0%B1%D0%B0%D0%B7-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
  * [Функции в SQL](#%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8-%D0%B2-sql)
    + [Виды JOIN'ов](#%D0%B2%D0%B8%D0%B4%D1%8B-join%D0%BE%D0%B2)
    + [Оконные функции](#%D0%BE%D0%BA%D0%BE%D0%BD%D0%BD%D1%8B%D0%B5-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8)
    + [UNION](#union)
    + [MERGE](#merge)
    + [UPSERT](#upsert)
    + [EXPLAIN](#explain)
    + [EXPLAIN ANALYSE](#explain-analyse)
  * [Транзакции](#%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D0%B8%D0%B8)
    + [Что такое транзакция](#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D0%B8%D1%8F)
    + [Какие есть уровни изоляции транзакций?](#%D0%BA%D0%B0%D0%BA%D0%B8%D0%B5-%D0%B5%D1%81%D1%82%D1%8C-%D1%83%D1%80%D0%BE%D0%B2%D0%BD%D0%B8-%D0%B8%D0%B7%D0%BE%D0%BB%D1%8F%D1%86%D0%B8%D0%B8-%D1%82%D1%80%D0%B0%D0%BD%D0%B7%D0%B0%D0%BA%D1%86%D0%B8%D0%B9)
    + [ACID (atomicity, consistency, isolation, durability)](#acid-atomicity-consistency-isolation-durability)
    + [CAP теорема](#cap-%D1%82%D0%B5%D0%BE%D1%80%D0%B5%D0%BC%D0%B0)
    + [MySQL vs PostgreSQL?](#mysql-vs-postgresql)
  * [Запросы](#%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D1%8B)
    + [Что быстрее один большой запрос или несколько маленьких(при условии что ответ одинаковый) и почему?](#%D1%87%D1%82%D0%BE-%D0%B1%D1%8B%D1%81%D1%82%D1%80%D0%B5%D0%B5-%D0%BE%D0%B4%D0%B8%D0%BD-%D0%B1%D0%BE%D0%BB%D1%8C%D1%88%D0%BE%D0%B9-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81-%D0%B8%D0%BB%D0%B8-%D0%BD%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE-%D0%BC%D0%B0%D0%BB%D0%B5%D0%BD%D1%8C%D0%BA%D0%B8%D1%85%D0%BF%D1%80%D0%B8-%D1%83%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D0%B8-%D1%87%D1%82%D0%BE-%D0%BE%D1%82%D0%B2%D0%B5%D1%82-%D0%BE%D0%B4%D0%B8%D0%BD%D0%B0%D0%BA%D0%BE%D0%B2%D1%8B%D0%B9-%D0%B8-%D0%BF%D0%BE%D1%87%D0%B5%D0%BC%D1%83)
    + [Как ускорить запрос?](#%D0%BA%D0%B0%D0%BA-%D1%83%D1%81%D0%BA%D0%BE%D1%80%D0%B8%D1%82%D1%8C-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81)
  * [Индексы](#%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D1%8B)
    + [Что такое индекс?](#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81)
    + [Виды и типы индексов](#%D0%B2%D0%B8%D0%B4%D1%8B-%D0%B8-%D1%82%D0%B8%D0%BF%D1%8B-%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81%D0%BE%D0%B2)
    + [Index vs PK](#index-vs-pk)
    + [Какие есть типы связей?](#%D0%BA%D0%B0%D0%BA%D0%B8%D0%B5-%D0%B5%D1%81%D1%82%D1%8C-%D1%82%D0%B8%D0%BF%D1%8B-%D1%81%D0%B2%D1%8F%D0%B7%D0%B5%D0%B9)
  * [Другое](#%D0%B4%D1%80%D1%83%D0%B3%D0%BE%D0%B5)
    + [Масштабирование БД](#%D0%BC%D0%B0%D1%81%D1%88%D1%82%D0%B0%D0%B1%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B1%D0%B4)
    + [Нормализация БД](#%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%B4)
    + [Как можно оптимизировать запрос с частичным поиском по строке?](#%D0%BA%D0%B0%D0%BA-%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE-%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D1%82%D1%8C-%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81-%D1%81-%D1%87%D0%B0%D1%81%D1%82%D0%B8%D1%87%D0%BD%D1%8B%D0%BC-%D0%BF%D0%BE%D0%B8%D1%81%D0%BA%D0%BE%D0%BC-%D0%BF%D0%BE-%D1%81%D1%82%D1%80%D0%BE%D0%BA%D0%B5)
    + [Что такое SQL Injection?](#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-sql-injection)
    + [Триггеры БД](#%D1%82%D1%80%D0%B8%D0%B3%D0%B3%D0%B5%D1%80%D1%8B-%D0%B1%D0%B4)
    + [Курсоры](#%D0%BA%D1%83%D1%80%D1%81%D0%BE%D1%80%D1%8B)
    + [Хранимые процедуры и функции](#%D1%85%D1%80%D0%B0%D0%BD%D0%B8%D0%BC%D1%8B%D0%B5-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D0%B4%D1%83%D1%80%D1%8B-%D0%B8-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8)
    + [ETL](#etl)
    + [Что такое VACUUM в PostgreSQL?](#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-vacuum-%D0%B2-postgresql)
# General

### Разница SQL и NoSQL баз данных

1. SQL databases use structured query language (SQL) and have a predefined schema. NoSQL databases have dynamic schemas for unstructured data.
2. SQL databases are vertically scalable (more power e.g. CPUs), while NoSQL databases are horizontally scalable (more machines).
3. SQL databases are table-based, while NoSQL databases are document, key-value, graph, or wide-column stores.
4. SQL databases are better for multi-row transactions, while NoSQL is better for unstructured data like documents or JSON.

## Функции в SQL

### Виды JOIN'ов

![Untitled](sql-joins.png)

### Оконные функции

**Оконная функция в SQL** — функция, которая работает с выделенным набором строк (окном, партицией) и выполняет вычисление для этого набора строк в отдельном столбце.

![sql-funcs.png](sql-funcs.png)

### UNION

UNION - комбинирует результат 2х и более SELECT запросов

Таблицы для UNION запросы должны иметь одинаковое:

- кол-во колонок
- типы колонок
- порядок колонок

### MERGE

Merge позволяет сделать операцию UPDATE, INSERT, DELETE без предварительного SELECT данных из таблицы. Он используется, когда надо надо данные из одной таблицы перебросить в другую.

### UPSERT

UPSERT позволяет выполнять команду insert если запись уже существует (с такими уникальными значениями),

### EXPLAIN

Это **удобное средство, которое помогает оптимизировать запросы**. С помощью инструкций EXPLAIN можно получать информацию о том, как выполняются инструкции SQL.

### EXPLAIN ANALYSE

As you correctly mention, the difference between explain & explain analyze is that **the former generates the query plan by estimating the cost, while the latter actually executes the query.** Thus, explain analyze will give you more accurate query plan / cost.

## Транзакции

### Что такое транзакция

Транзакция — это элементарная операция в базе данных.

Однако транзакция может состоять и из нескольких операций: в этом ключе — это логически целостная процедура, в которой должны быть выполнены либо все операции — либо ни одна из них.

Транзакция начинается с команды BEGIN и заканчивается командой commit либо отменяется командой rollback

### Какие есть уровни изоляции транзакций?

| Уровень изоляции | «Грязное» чтение        | Неповторяемое чтение | Фантомное чтение        | Аномалия сериализации |
| ---------------- | ----------------------- | -------------------- | ----------------------- | --------------------- |
| Read uncommitted | Допускается, но не в PG | Возможно             | Возможно                | Возможно              |
| Read committed   | Невозможно              | Возможно             | Возможно                | Возможно              |
| Repeatable read  | Невозможно              | Невозможно           | Допускается, но не в PG | Возможно              |
| Serializable     | Невозможно              | Невозможно           | Невозможно              | Невозможно            |

Базовый уровень изоляции в **PostgreSQL – Read Committed.**

Причина наличия в PostgreSQL только трёх уровней изоляции состоит в том, что только так можно сопоставить стандартные уровни изоляции с архитектурой многоверсионного управления конкурентным доступом.

Базовый уровень изоляции в **MySQL – Repeatable read.**

**"Грязное" чтение**: Транзакция читает данные, записанные параллельной незавершённой транзакцией.

**Неповторяемое чтение**: Транзакция повторно читает те же данные, что и раньше, и обнаруживает, что они были изменены другой транзакцией (которая завершилась после первого чтения).

**Фантомное чтение**: Транзакция повторно выполняет запрос, возвращающий набор строк для некоторого условия, и обнаруживает, что набор строк, удовлетворяющих условию, изменился из-за транзакции, завершившейся за это время.

**Аномалия сериализации**: Когда невозможно предсказать в каком порядке выполнятся транзакции. Важно, когда берем проценты от числа.

- 1000 * 110% + 1000 = 2100
- (1000 + 1000) * 110% = 2200

##

Для выбора нужного уровня изоляции транзакций используется команда [SET TRANSACTION](https://postgrespro.ru/docs/postgresql/9.4/sql-set-transaction).

### ACID (atomicity, consistency, isolation, durability)

ACID — набор требований к транзакционной системе, обеспечивающий наиболее надёжную и предсказуемую её работу

***Атомарность*** гарантирует, что каждая транзакция будет выполнена полностью или не будет выполнена совсем. Не допускаются промежуточные состояния.

***Констистетность***, то есть до выполнения операции и после база остается постоянной.

***Изолированность***. Во время выполнения транзакции параллельные транзакции не должны оказывать влияния на её результат. 

- Блокировки — это когда мы блокируем данные в базе.
- Версии — это когда внутри базы при каждом обновлении создается новая версия данных и сохраняется старая.

***Надежность***. Если пользователь получил подтверждение от системы, что транзакция выполнена, он может быть уверен, что сделанные им изменения не будут отменены из-за какого-либо сбоя.

### CAP теорема

Теорема CAP — эвристическое утверждение о том, что в любой реализации распределённых вычислений возможно обеспечить не более двух из трёх следующих свойств

- *согласованность данных* (англ. *consistency*) — во всех вычислительных узлах в один момент времени данные не противоречат друг другу;
- *доступность* (англ. *availability*) — любой запрос к распределённой системе завершается корректным откликом, однако без гарантии, что ответы всех узлов системы совпадают;
- *устойчивость к разделению* (англ. *partition tolerance*) — расщепление распределённой системы на несколько изолированных секций не приводит к некорректности отклика от каждой из секций.

![Untitled](cap.png)

### MySQL vs PostgreSQL?

PostgreSQL быстрая open-source СУБД, а MySQL более прост в настройке.

Улучшенная конкурентность в Postgres засчет MVCC, который поддерживает параллельный доступ.

|  | PostgreSQL | MySQL |
| --- | --- | --- |
| Architecture | Object relational; multiprocess | Relational; single process |
| Data types supported | Numeric, date/time, character, boolean, enumerated, geometric, network address, JSON, XML, HSTORE, arrays, ranges, composite https://www.postgresql.org/docs/current/datatype.html | Numeric, date/time, character, spatial, JSON https://dev.mysql.com/doc/refman/8.0/en/data-types.html |
| Indexes supported | B-tree, hash, GiST, SP-GiST, GIN, and BRIN | Primarily B-tree; R-tree, hash, and inverted indexes for certain data types |
| Performance | Suited for applications with high volume of both reads and writes | Suitable for applications with high volume of reads |
| Security | Access control, multiple encrypted connection options https://www.postgresql.org/docs/13/runtime.html | Access control, encrypted connections https://dev.mysql.com/doc/refman/8.0/en/security.html |

## Запросы

### Что быстрее один большой запрос или несколько маленьких(при условии что ответ одинаковый) и почему?

### Как оптимизировать запрос?

**1. Оптимизация кода**

Вместо звездочки использовать имена столбцов

Дополнительный Where

**2. Сведите к минимуму использование подзапросов.**

Используйте оператор `IN` аккуратно, поскольку на практике он имеет низкую производительность и может быть эффективен только при использовании критериев фильтрации в подзапросе.

**3. Использовать WITH & CTE.**

Common Table Expressions — временные таблицы, которые создаются только в рамках выполнения какой-либо операции и удаляются, как только становятся не нужны

## Индексы

### Что такое индекс?

Индекс – это объект базы данных, создаваемый с целью повышения производительности поиска данных.

Не стоит использовать индексы для небольших таблиц. Не стоит использовать индексы для таблиц, в которых, как предполагается, будут часто добавляться новые данные, либо эти данные будут изменяться.

Индекс нужен тогда, когда запросы выполняются часто и долго. Ненужные индексы нужно удалять.

### Виды и типы индексов

**Кластерные индексы -** хранят данные записей целиком и отдельно.

**Обычные индексы -** хранят ссылки на записи (PK). Используются отсортированные таблицы, поэтому потребление памяти там меньше.

**В БД основные типы:**

B-tree, простратенственные индексы (spatial grid), hash index, bitmap, function based, reverted.

В PostgreSQL могут быть и другие виды типо GiST, GIN.

|                      | MySQL                            | PostgreSQL                                  | MS SQL                                                                                       | Oracle                                     |
| -------------------- | -------------------------------- | ------------------------------------------- | -------------------------------------------------------------------------------------------- | ------------------------------------------ |
| B-Tree index         | Есть                             | Есть                                        | Есть                                                                                         | Есть                                       |
| Spatial indexes      | R-Tree с квадратичным разбиением | Rtree_GiST(используется линейное разбиение) | 4-х уровневый Grid-based spatial index (отдельные для географических и геодезических данных) | R-Tree c квадратичным разбиением; Quadtree |
| Hash index           | Только в таблицах типа Memory    | Есть                                        | Нет                                                                                          | Нет                                        |
| Bitmap index         | Нет                              | Есть                                        | Нет                                                                                          | Есть                                       |
| Reverse index        | Нет                              | Нет                                         | Нет                                                                                          | Есть                                       |
| Inverted index       | Есть                             | Есть                                        | Есть                                                                                         | Есть                                       |
| Partial index        | Нет                              | Есть                                        | Есть                                                                                         | Нет                                        |
| Function based index | Нет                              | Есть                                        | Есть                                                                                         | Есть                                       |

…….

### Index vs PK

A key (minimal superkey) is a set of attributes, the values of which are unique for every tuple (every row in the table at some point in time).

An index is a performance optimisation feature that enables data to be accessed faster.

PK vs FK

PK — однозначно идентифицирует какую-то строку в таблице.
FK — для связи таблиц с друг другом

Оба могут состоять более чем из одного столбца.

### Какие есть типы связей?

Есть три типа связей: 

- 1 к 1: данные о сотрудниках дочерних отделов (почти всегда такие таблицы объединяются)
- 1 ко многим: у одного клиента может быть несколько телефонов, но в тоже время мы можем быть уверены в том, что один конкретный номер может быть только у одного клиента
- много ко многим: первое — одну книгу может написать несколько авторов, второе — автор может написать несколько книг.

### Как чистить индексы?

- `DROP INDEX ... on ...`
- `VACUUM`
## Другое

### Масштабирование БД

**Горизонтальное масштабирование:** увелечение кол-ва серверов

**Вертиклаьное масштабирование:** наращивание мощностей сервера

**Репликация:** копирование данных между серверами. При использовании такого метода выделяют два типа серверов: master и slave. Мастер используется для записи или изменения информации, слейвы — для копирования информации с мастера и её чтения.

![Untitled](db-1.png)

**Партицирование:** в разбиении данных на части по какому-либо признаку. Например, таблицу можно разбить на две по признаку чётности. поиск осуществляется не по всей таблице, а лишь по её части.

![Untitled](db-2.png)

**Шардинг:** части таблицы хранятся раздельно, на разных физических серверах.

![Untitled](db-3.png)

### Нормализация БД

**Нормализация** — это процесс организации данных в базе данных, включающий создание таблиц и установление отношений между ними в соответствии с правилами, которые обеспечивают защиту данных и делают базу данных более гибкой, устраняя избыточность и несогласованные зависимости.

Избыточность устраняется, как правило, за счёт декомпозиции отношений (таблиц), т.е. разбиения одной таблицы на несколько.

Избыточность данных – это когда одни и те же данные хранятся в базе в нескольких местах, именно это и приводит к аномалиям.

**Нормальные формы БД:**

| Форма | Концепт |
| --- | --- |
| 1NF | -       нет дублирующихся строк в таблице
-       все атрибуты простые (атомарные) |
| 2NF = 0 + 1NF | -       у таблицы должен быть первичный ключ PK
-       все атрибуты должны описывать первичный ключ полностью, а не только какую-то его часть |
| 3NF = 0 + 2NF | Не должно быть зависимостей одних неключевых атрибутов от других |
| BOYCE-CODD NORMAL FORM (BCNF OR 3.5NF) = 0 + 3NF | Несколько полей имеют нетривиальную и неприводимую слева функциональную зависимость, которую можно вынести в отдельную таблицу |
| 4NF = 0 + BCNF | {Ресторан, Вид пиццы, Район доставки} -> декомпозиция в:
{Ресторан} → {Вид пиццы} 
{Ресторан} → {Район доставки} |

### Как можно оптимизировать запрос с частичным поиском по строке?

### Что такое SQL Injection?

Это атака на базу данных, которая позволит выполнить некоторое действие, которое не планировалось создателем скрипта.

### Триггеры БД

Триггеры представляют обработчики событий. Они выполняются при наступлении какого-либо простого действия в SQL. Такими действиями обычно являются: удаление, вставка и обновление данных.

### Курсоры

Курсоры – некое подмножество из таблицы, результирующий набор данных, в которым можно выполнять операции с отдельными строками.

### Хранимые процедуры и функции

Хранимые процедуры позволяют содержать часто используемый SQL запрос на сервере. Это обеспечивает лучшую производительность, поскольку данный запрос должен анализироваться только однажды и уменьшается трафик между сервером и клиентом.

Хранимые функции - тоже что и процедуры, но при этом возвращают обязательно какое-то значение.

| Плюсы | Минусы |
| --- | --- |
| Скорость | PL/PGSQL старый и древний язык |
| Управление доступом | Нету менеджера зависимостей. |
| Меньшая вер-ть SQL Injection |  |

### ETL

**Extract, Transform, Load ***—* общий термин для всех процессов миграции данных из одного источника в другой.

**Типичные этапы ETL-процесса:**

- извлечение данных из источника (файл, БД, веб-страница и пр);
- очистка данных (приведение разнородных данных к единому формату, удаление лишнего, устранение недочетов и пр);
- обогащение (применение алгоритмов или внешних источников для получения новых данных, связанных с обрабатываемыми данными);
- трансформирование;
- загрузка (интеграция в единую целевую модель).

### Что такое VACUUM в PostgreSQL?

VACUUM высвобождает пространство, занимаемое «мёртвыми» кортежами. При обычных операциях PostgreSQL кортежи, удалённые или устаревшие в результате обновления, физически не удаляются из таблицы; они сохраняются в ней, пока не будет выполнена команда VACUUM .

[Топ-65 вопросов по SQL с собеседований, к которым вы должны подготовиться в 2019 году. Часть I](https://habr.com/ru/company/otus/blog/461067/)